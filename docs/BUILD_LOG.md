# Build Log

Short, dated notes for significant architecture or builder/runtime changes.

- 2025-12-06: **[SCORING-DEBUG] Scoring Debug Panel for Dev Tools** âœ… IMPLEMENTED
  - **Goal:** Add scoring calculation trace visualization to dev tools
  - **Created `server/routes/devScoring.ts`:**
    - `POST /api/dev/scoring-trace` endpoint
    - Returns per-question and per-category score breakdowns
    - Uses same scoring logic as production (calculateSurveyScores)
    - Guarded by `NODE_ENV !== 'production'`
  - **Created `client/src/components/builder-v2/ScoringDebugSection.tsx`:**
    - Collapsible scoring debug panel for Survey Debug Panel
    - Shows category breakdown table, question contributions table
    - Final band selection with matched rule
  - **Created `client/src/pages/dev/ScoringDebugPage.tsx`:**
    - Standalone full-page scoring debug tool
    - Survey/response selector with refresh
    - All score calculation details in one view
  - **Updated `SurveyDebugPanel.tsx`:** Added ScoringDebugSection
  - **Updated `App.tsx`:** Added `/dev/scoring-debug` route
  - **Updated `AppSidebar.tsx`:** Added navigation link
  - **Updated `server/routes/index.ts`:** Registered dev scoring routes
  - **Created `docs/DEV_TOOLS.md`:** Comprehensive dev tools documentation
  - **Tests:** 4 new tests for ScoringDebugSection (all passing)
  - **Note:** Dev tools only available when running `npm run dev` (not Docker)

- 2025-12-05: **[TMPL-001] Dashboard Routing Verification** âœ… TESTED
  - **Verified all 3 dashboard modes route correctly:**
    - 5D Smoke Test (5 canonical) â†’ Insight Dimensions (7 tabs, blue badge)
    - Turnover Risk (1 canonical) â†’ Category Analytics (5 tabs, purple badge)
    - Wellbeing Pulse (4 canonical) â†’ Insight Dimensions (7 tabs, blue badge)
    - Canadian EE Survey (no scoring) â†’ Basic Analytics (no tabs)
  - **Routing logic confirmed:**
    - â‰¥3 canonical 5D category IDs â†’ Insight Dimensions
    - Scoring enabled + <3 canonical â†’ Category Analytics
    - No scoring â†’ Basic Analytics
  - **Next:** Configure templates per TMPL-001 recommendations

- 2025-12-05: **[ADMIN-100] Scoring Admin Control Plane Ticket** ðŸ“ CREATED
  - **Type:** Epic (Read-Only Phase 1)
  - **Goal:** Centralized view of scoring model (indices, dimensions, categories, bands)
  - **Route:** `/admin/scoring`
  - **Blockers:** MODEL-001 (Scoring Model Registry) must be defined first
  - **See:** `docs/tickets/ADMIN-100-scoring-admin-control-plane.md`

- 2025-12-05: **[ANAL-DASH-020] Basic Analytics Dashboard** âœ… IMPLEMENTED
  - **Goal:** Lightweight analytics for surveys without scoring
  - **Created `client/src/components/analytics/NoScoringBanner.tsx`:**
    - Informational banner explaining question-level only analytics
    - Clear messaging about limited view
  - **Created `client/src/components/analytics/TopBottomItemsCard.tsx`:**
    - Shows top 5 and bottom 5 questions by average rating
    - Filters to numeric questions only (rating, likert, nps)
    - Visual ranking with performance bars
  - **Updated `client/src/pages/AnalyticsPage.tsx`:**
    - Added conditional rendering for `dashboardMode.mode === 'basic'`
    - Basic mode shows: NoScoringBanner, ParticipationMetrics, TopBottomItems, QuestionSummary
    - NO tabs in basic mode (simplified single-page view)
  - **Updated `client/src/components/analytics/index.ts`:** Added exports
  - **Updated test:** `AnalyticsPage.integration.test.tsx` - expects "Question-Level Analytics"
  - **71 tests passing**

- 2025-12-05: **[TMPL-001] Template Scoring Configuration Ticket** ðŸ“ CREATED
  - **Goal:** Configure all 37 templates with appropriate scoring for analytics routing
  - **Audit Results:**
    - 13 templates have scoring enabled (various categories)
    - 24 templates have no scoring configured
  - **Scoring Criteria Defined:**
    - **5D Insight Dimensions:** Employee engagement, wellbeing, organizational health surveys
    - **Generic Category Scoring:** Training, skills, program evaluation surveys
    - **Basic (No Scoring):** Pulse checks, qualitative, logic-based templates
  - **Logic Template Handling:** Documented 3 options for branching surveys
  - **See:** `docs/tickets/TMPL-001-template-scoring-configuration.md`

- 2025-12-05: **[ANAL-DASH-010] Generic Scoring Dashboard** âœ… IMPLEMENTED
  - **Goal:** Provide analytics for non-5D scored surveys (category-based)
  - **Dev Tools Navigation:**
    - Added "Dev Tools" section to `AppSidebar.tsx` (dev-only)
    - Links to `/dev/inspector` and `/dev/analytics-inspector`
  - **Created `client/src/hooks/useDashboardMode.ts`:**
    - `DashboardMode` type: `insight-dimensions` | `generic-scoring` | `basic`
    - `isCanonical5DDashboard()` helper to detect 5D surveys
    - `useDashboardMode()` hook returns mode, title, flags
  - **Created `client/src/components/analytics/CategoryLeaderboardTable.tsx`:**
    - Ranked view of scoring categories (highest = #1)
    - Uses `scoreConfig.scoreRanges` for bands (not hardcoded 5D bands)
    - No burnout inversion logic
    - Trophy/Medal/Award icons for top 3
  - **Created `client/src/components/analytics/CategoryScoreCard.tsx`:**
    - Overall score summary card
    - Shows score, band, response count, category count
    - Uses `scoreConfig.scoreRanges` for band resolution
  - **Updated `client/src/pages/AnalyticsPage.tsx`:**
    - Added dashboard mode detection
    - Dynamic tab labels: "Insights Home" vs "Overview", "Dimensions" vs "Categories"
    - Conditionally shows Managers/Benchmarks tabs (5D only)
    - Conditionally shows Trends tab (scoring enabled only)
    - CategoryLeaderboardTable for generic-scoring mode
    - CategoryScoreCard in Overview tab for generic-scoring mode
  - **Updated `client/src/components/analytics/index.ts`:** Added exports

- 2025-12-05: **[ANAL-QA-040] Analytics Inspector (Dev Only)** âœ… IMPLEMENTED
  - **Goal:** "Pop the hood" debugging view for analytics
  - **Route:** `/dev/analytics-inspector` (dev-only, behind `import.meta.env.DEV`)
  - **Created `client/src/pages/dev/AnalyticsInspectorPage.tsx`:**
    - Survey selector dropdown
    - Survey configuration panel (ID, scoring enabled, categories, score ranges)
    - Derived analyticsState panel (mode, showScoring, showTrends, message)
    - Raw JSON panels for all metrics:
      - Participation Metrics
      - Index Distribution
      - Band Distribution  
      - Question Summary
      - Manager Index Summary
      - Index Trends Summary
      - Versions
      - scoreConfig (raw)
    - Collapsible sections with status indicators (OK/Loading/Error)
    - Copy JSON button per panel
    - Refresh All button
  - **Updated `client/src/App.tsx`:** Added dev-only route

- 2025-12-05: **[ANAL-QA-020] AnalyticsPage Integration Tests** âœ… IMPLEMENTED
  - **Goal:** UI-level guarantees that the right analytics appear for the right kind of survey
  - **Created `client/src/__tests__/analytics/AnalyticsPage.integration.test.tsx`:**
    - 18 integration tests covering key scenarios
    - Tests state detection for: 5D scored, non-scored, misconfigured, single-version, no-responses
    - Verifies correct messages appear for each state
    - Tests empty state handling
  - **Test Coverage:**
    - Scoring disabled â†’ shows "Scoring Not Enabled", participation + questions only
    - Misconfigured scoring â†’ shows "Scoring Misconfigured" error with guidance
    - Single version â†’ classifies as "Single Snapshot Mode", shows scoring but not trends
    - No responses â†’ shows "Waiting for Responses" state
    - All null dimension scores â†’ detects misconfigured state
  - **Tests:** 71 total analytics tests passing (18 integration + 21 state + 32 backend)

- 2025-12-05: **[ANAL-QA-050] Confidence / Empty-State Rules** âœ… IMPLEMENTED
  - **Goal:** Make analytics failures obvious and safe
  - **Created `client/src/utils/analyticsState.ts`:**
    - `deriveAnalyticsScoringState()` - classifies survey into states:
      - `no-responses` - show waiting state
      - `no-scoring` - show participation + questions only
      - `misconfigured-scoring` - show error with guidance
      - `single-version` - show scoring but not trends
      - `healthy` - show all analytics
    - `checkAnalyticsInvariants()` - dev-mode logging for broken states
    - `isDistributionEmpty()` - helper for empty checks
  - **Updated `client/src/pages/AnalyticsPage.tsx`:**
    - Added `AnalyticsStateBanner` component for state warnings
    - Added `SingleVersionIndicator` for trend limitations
    - Added `ScoringDisabledCard` for unavailable charts
    - Conditional rendering based on analytics state
    - Dev-mode invariant checking via useEffect
  - **Tests:** 21 new tests covering all states
  - **No changes to scoring calculations or APIs**

- 2025-12-05: **[ANAL-QA-030] Shared Helpers Refactor** âœ… IMPLEMENTED
  - **Goal:** Eliminate drift between scoring logic, analytics helpers, and UI
  - **Enhanced `shared/analyticsBands.ts`:**
    - `INDEX_BAND_DEFINITIONS` - canonical source with thresholds
    - `resolveBandIndex()` - for bucket counting
    - `getColorForScore()` - direct score-to-color lookup
    - `createEmptyBandStats()` - for distribution chart initialization
    - `DISTRIBUTION_BUCKET_COLORS` - for index distribution charts
    - `TREND_COLORS` - for trend direction indicators
    - Strong TypeScript types: `BandId`, `TrendDirection`, `IndexBandInfo`
  - **Refactored `server/utils/analytics.ts`:**
    - `DEFAULT_INDEX_BANDS` now derives from shared definitions
    - `computeIndexBandDistribution` uses `resolveBandIndex()`
    - `calculateBandDistribution` uses shared helpers
    - `createEmptyBandDistribution` uses `createEmptyBandStats()`
  - **Refactored Client Components:**
    - `DimensionLeaderboardTable` - uses `getColorForScore()`, updated types
    - `IndexDistributionChart` - uses `DISTRIBUTION_BUCKET_COLORS`
    - `BeforeAfterComparisonChart` - uses `TREND_COLORS`
  - **Tests:** 53 tests pass (all shared + analytics tests)

- 2025-12-05: **[ANAL-QA-010] Golden Fixtures & Analytics Unit Tests** âœ… IMPLEMENTED
  - **Golden Fixture File:** `server/__tests__/fixtures/analyticsFixtures.ts`
    - 10 test responses (5 per manager) with hand-calculated expected values
    - 8 questions (6 scorable, 2 non-scorable) across 4 categories
    - Edge case fixtures: empty responses, single response, unscored survey
  - **Unit Tests:** `server/__tests__/utils/analytics.test.ts` (32 tests)
    - Participation metrics validation
    - Question-level statistics (avg, min, max, completion rate)
    - Manager summary grouping and counts
    - Index distribution bucket validation
    - Score config structure validation
    - SCORE-002 regression test (min/max not minScore/maxScore)
    - calculateSurveyScores integration tests
  - **Bug Discovered:** Reverse scoring via `optionScores` not applied for rating questions
    - Documented as known limitation with TODO for future fix
    - Rating questions use raw answer value, not optionScores mapping
  - **Files Created:**
    - `server/__tests__/fixtures/analyticsFixtures.ts`
    - `server/__tests__/utils/analytics.test.ts`

- 2025-12-05: **[ANAL-DASH-001] Multi-Mode Analytics Dashboards â€“ Epic Created** ðŸ“‹ ROADMAP
  - **Intent:** Introduce runtime dashboard routing so each survey gets appropriate analytics
  - **Three Dashboard Modes:**
    - **Insight Dimensions** â€“ Full 5D Evalia view (existing AnalyticsPage)
    - **Generic Scoring** â€“ Category-based view for non-5D scored surveys
    - **Basic Analytics** â€“ Participation + question-level only for non-scored surveys
  - **Sub-tickets Created:**
    - ANAL-DASH-010: Generic Scoring Dashboard (Category-Based)
    - ANAL-DASH-020: Basic Analytics Dashboard (Non-Scored)
  - **Routing Logic:** Based on `scoreConfig.enabled`, `categories.length`, and category ID matching
  - **Status:** Design phase, tickets documented

- 2025-12-05: **[SCORE-002] Score Band Property Alignment â€“ Bugfix** âœ… FIXED
  - **Root Cause:** Property name mismatch between schema and scoring code
    - `scoreBandSchema` defines `min` / `max` properties
    - `calculateSurveyScores` was reading `minScore` / `maxScore` (undefined)
    - This caused all normalized scores to be `0` and band matching to fail
  - **Fix Applied:**
    - Updated 4 lines in `shared/schema.ts` to use `rule.min` / `rule.max`
    - Added `category` and `interpretation` optional fields to `scoreBandSchema`
  - **Golden Test Added:**
    - `shared/__tests__/calculateSurveyScores.test.ts` with 7 test cases
    - Validates min/max property usage, band matching, multi-category scoring
    - Prevents regression of minScore/maxScore misuse
  - **Files Changed:**
    - `shared/schema.ts` (lines 749-751, 777-779, 788-790)
    - `src/core/results/resultsSchemas.ts` (added category, interpretation)
    - `shared/__tests__/calculateSurveyScores.test.ts` (new)
  - **Verified:** Analytics endpoints now return correct dimension scores

- 2025-12-06: **[ANAL-QA-001] Analytics Hardening Epic â€“ Created**
  - **Intent:** Pause "new shiny" features for one cycle; focus on stability, correctness, and guardrails
  - **Subtickets Created:**
    - ANAL-QA-010: Golden Fixtures & Analytics Unit Tests
    - ANAL-QA-020: AnalyticsPage Integration Tests
    - ANAL-QA-030: Shared Bands & Dimension Helpers Refactor
    - ANAL-QA-040: Analytics Inspector (Dev Only)
    - ANAL-QA-050: Confidence/Empty-State Rules
  - **Key Goals:**
    - Prove analytics numbers are mathematically correct with golden fixtures
    - Test UI wiring (tabs â†’ components, version selector propagation)
    - Centralize band/dimension logic (remove drift)
    - Add dev tooling for debugging
    - Clear empty-state messaging
  - **Status:** Ready to implement

- 2025-12-06: **[ANAL-DIM-001] Dimension Leaderboard Table â€“ Full Implementation** âœ… IMPLEMENTED
  - **Shared Helper:**
    - Created `shared/analyticsBands.ts` with centralized band resolution logic
    - `resolveIndexBand()` - maps scores to bands with burnout inversion support
    - `resolveTrendDirection()` - determines trend arrow based on Â±1 threshold
    - `calculatePerformanceScore()` - inverts burnout scores for ranking
    - Exports `INDEX_BANDS` constants for consistent band definitions
  - **Frontend Component:**
    - Created `DimensionLeaderboardTable` showing all 5 dimensions ranked by performance
    - Columns: Rank, Dimension, Score (with band color), Band, Change, Performance bar
    - Trophy icon for #1, warning icon for #5 (worst performer)
    - Burnout Risk handled correctly (lower score = better, displayed with "Lower is better")
    - Version-aware: respects global VersionSelector
    - Change calculation vs previous version with trend arrows
  - **Integration:**
    - Added to Dimensions tab in AnalyticsPage (above existing charts)
    - Reuses `useIndexTrendsSummary` data - no new backend required
  - **Files Changed:**
    - `shared/analyticsBands.ts` (new)
    - `client/src/components/analytics/DimensionLeaderboardTable.tsx` (new)
    - `client/src/components/analytics/index.ts`
    - `client/src/pages/AnalyticsPage.tsx`
    - `docs/tickets/ANAL-DIM-001-dimension-leaderboard.md` (new)

- 2025-12-06: **[ANAL-IA-001] Analytics Information Architecture â€“ Structural Refactor** âœ… IMPLEMENTED
  - **New 7-Section Tab Structure:**
    - Insights Home | Dimensions | Managers | Trends | Questions | Responses | Benchmarks
  - **Component Relocation:**
    - `ParticipationMetricsCard`, `IndexDistributionChart`, `BandDistributionChart` â†’ Insights Home
    - `IndexDistributionChart`, `BandDistributionChart` (duplicated) â†’ Dimensions tab
    - `ManagerComparisonTable` â†’ Managers tab
    - `DimensionTrendsChart`, `BeforeAfterComparisonChart` â†’ Trends tab
    - `QuestionSummaryTable` â†’ Questions tab (moved from Domains)
    - Placeholder cards added for Responses and Benchmarks tabs
  - **Removed:** Export tab (functionality deferred)
  - **Preserved:** VersionSelector remains global (visible on all tabs)
  - **No Backend Changes:** All metric IDs, APIs, and hooks unchanged
  - **Files Changed:**
    - `client/src/pages/AnalyticsPage.tsx`
    - `docs/tickets/ANAL-IA-001-unified-analytics-ia.md`

- 2025-12-06: **[ANAL-009] Before/After Index Comparison â€“ Full Implementation** âœ… IMPLEMENTED
  - **Backend:**
    - Added `computeBeforeAfterIndexComparison()` helper to `server/utils/analytics.ts`
    - Compares average Insight Dimension scores between two scoring versions
    - Calculates change values, percentage changes, and trend indicators (up/down/neutral)
    - Returns summary with improved/declined/stable counts and overall trend
    - Added `BEFORE_AFTER_INDEX_COMPARISON` metric ID and route handler
  - **Shared Types:**
    - Added `ComparisonVersionInfo`, `DimensionComparison`, `ComparisonSummary` interfaces
    - Updated `BeforeAfterIndexComparisonData` with detailed version info and comparisons
    - Added `BEFORE_AFTER_INDEX_COMPARISON` to `METRIC_IDS` and `METRIC_TYPE_MAP`
  - **Frontend:**
    - Created `useBeforeAfterComparison` hook for data fetching
    - Created `BeforeAfterComparisonChart` component with:
      - Version selector dropdowns for "Before" and "After" versions
      - Grouped horizontal bar chart comparing scores per dimension
      - Summary card showing overall trend (positive/negative/mixed/stable)
      - Change indicators with color coding (green=up, red=down, gray=neutral)
      - Custom tooltip with before/after values and change details
      - Loading, error, and "not enough versions" states
  - **AnalyticsPage Integration:**
    - Integrated into Trends tab (replaced placeholder)
    - Added version state management for before/after selection
    - Fetches versions list for comparison selector
  - **Files Changed:**
    - `shared/analytics.ts`
    - `server/utils/analytics.ts`
    - `server/routes/analytics.ts`
    - `client/src/components/analytics/useBeforeAfterComparison.ts` (new)
    - `client/src/components/analytics/BeforeAfterComparisonChart.tsx` (new)
    - `client/src/components/analytics/index.ts`
    - `client/src/pages/AnalyticsPage.tsx`
    - `docs/tickets/ANAL-009-before-after-comparison.md` (new)

- 2025-12-06: **Added new tickets to support next-phase capabilities**
  - **AIQ-001**: Question Quality Check (Builder UX)
  - **ADMIN-010**: Research Notes & Evidence Fields
  - **ADMIN-011**: Editable Band Narratives
  - **ADMIN-022**: Weight Simulation Panel (v1)
  - **ADMIN-023**: AI Explanation Layer for Simulations
  - **MULTI-001**: Consultant â†’ Org â†’ Survey Data Model
  - **MULTI-003**: AI Portfolio Summary (Consultant Mode)
  - **Future AIQ tickets** (AIQ-003 â†’ AIQ-008): Research note generation, band narrative optimization, question set coherence, manager plan generation, fatigue advisor, AI deck creation
  - These tickets support differentiation across survey design quality, transparent indices, consultant enablement, and AI-driven insight workflows.

- 2025-12-06: **[ANAL-008] Dimension Trends Summary â€“ Full Implementation** âœ… TESTED
  - **Backend:**
    - Added `computeIndexTrendsSummary()` helper to `server/utils/analytics.ts`
    - Fetches all scoring versions and computes average index scores per version
    - Returns trend points with scores for all 5 Insight Dimensions
    - Added `INDEX_TRENDS_SUMMARY` metric ID and route handler
  - **Shared Types:**
    - Added `IndexTrendPoint`, `IndexTrendsSummaryData` interfaces
    - Added `INDEX_TRENDS_SUMMARY` to `METRIC_IDS` and `METRIC_TYPE_MAP`
  - **Frontend:**
    - Created `useIndexTrendsSummary` hook for data fetching
    - Created `DimensionTrendsChart` component with:
      - Recharts line chart visualization
      - Multiple dimension lines with color coding
      - Custom tooltip with version/date and score details
      - Single-version and empty state handling
      - Burnout Risk shown with dashed line (lower is better)
  - **AnalyticsPage Integration:**
    - Integrated into Trends tab
    - Added "Before/After Comparison" placeholder for ANAL-009
  - **Files Changed:**
    - `shared/analytics.ts`
    - `server/utils/analytics.ts`
    - `server/routes/analytics.ts`
    - `client/src/components/analytics/useIndexTrendsSummary.ts` (new)
    - `client/src/components/analytics/DimensionTrendsChart.tsx` (new)
    - `client/src/components/analytics/index.ts`
    - `client/src/pages/AnalyticsPage.tsx`
    - `docs/tickets/ANAL-008-dimension-trends.md` (new)

- 2025-12-06: **[ANAL-007] Manager Comparison â€“ Full Implementation** âœ… TESTED
  - **Backend:**
    - Added `computeIndexSummaryByManager()` helper to `server/utils/analytics.ts`
    - Groups responses by `managerId` from metadata
    - Computes per-manager: respondentCount, completionRate, avgIndexScore, bandDistribution
    - Added `manager_index_summary` endpoint to analytics routes
  - **Frontend:**
    - Created `useManagerIndexSummary` hook for data fetching
    - Created `ManagerComparisonTable` component with:
      - Sortable columns (manager, respondents, completion, avg score)
      - Band distribution mini-visualization (colored stacked bar)
      - Score badge with color coding by band
      - Trend placeholder (stub)
    - Loading, error, and empty states
  - **Shared Types:**
    - Added `ManagerIndexSummaryData`, `ManagerSummaryItem`, `ManagerBandDistribution` interfaces
    - Added `MANAGER_INDEX_SUMMARY` to `METRIC_IDS` and `METRIC_TYPE_MAP`
  - **AnalyticsPage Integration:**
    - Integrated into Managers tab
    - Added "Self vs Team Comparison" placeholder for ANAL-008
  - **Files Changed:**
    - `server/utils/analytics.ts`
    - `server/routes/analytics.ts`
    - `shared/analytics.ts`
    - `client/src/components/analytics/useManagerIndexSummary.ts` (new)
    - `client/src/components/analytics/ManagerComparisonTable.tsx` (new)
    - `client/src/components/analytics/index.ts`
    - `client/src/pages/AnalyticsPage.tsx`
    - `docs/tickets/ANAL-007-manager-comparison.md` (new)

- 2025-12-06: **[ANAL-006] Question Summary Table â€“ Full Implementation** âœ… TESTED
  - **Backend:**
    - Added `computeQuestionSummary()` helper to `server/utils/analytics.ts`
    - Added `question_summary` endpoint to analytics routes
    - Computes per-question completion rate, average value, and distribution
  - **Frontend:**
    - Created `useQuestionSummary` hook for data fetching
    - Created `QuestionSummaryTable` component with:
      - Sortable columns (question #, completion rate, avg value, answers)
      - Filter by question type
      - Inline distribution visualization
      - Tooltip for full question text and distribution details
  - **Shared Types:**
    - Added `QuestionSummaryData`, `QuestionSummaryItem`, `OptionDistribution` interfaces
    - Added `QUESTION_SUMMARY` to `METRIC_IDS` and `METRIC_TYPE_MAP`
  - **AnalyticsPage Integration:**
    - Added to Domains tab
  - **Files Changed:**
    - `server/utils/analytics.ts`
    - `server/routes/analytics.ts`
    - `shared/analytics.ts`
    - `client/src/components/analytics/useQuestionSummary.ts` (new)
    - `client/src/components/analytics/QuestionSummaryTable.tsx` (new)
    - `client/src/components/analytics/index.ts`
    - `client/src/pages/AnalyticsPage.tsx`
  - **Browser Testing (2025-12-06):**
    - âœ… Table renders with correct data (5 responses, 8 questions)
    - âœ… Completion rates display correctly (100%)
    - âœ… Average values calculate correctly (3.6, 2.4, etc.)
    - âœ… Min/Max ranges shown
    - âœ… Distribution mini-charts display
    - âœ… Filter by question type works (Rating, Likert, Checkbox, etc.)
    - âœ… No console errors
    - âœ… API endpoint returns 200 OK

- 2025-12-06: **[ARCHITECTURE] Two-Layer Scoring Model â€“ Major Architecture Upgrade**
  - **Introduced proprietary 5-Index Evalia Insight Model** as fixed output layer
  - **Added Dimensional Scoring Layer** as configurable intermediate layer
  - **Created Scoring Model Architecture doc:** `docs/scoring/SCORING_MODEL_OVERVIEW.md`
  - **Architecture overview:**
    ```
    Categories (builder) â†’ Dimensions (configurable) â†’ Indices (fixed) â†’ Bands
    ```
  - **Key principle:** Indices and Dimensions are now first-class system entities
  - **Requirement:** All future analytics draw from Scoring Model Registry (MODEL-001)

- 2025-12-06: **[ADMIN-000] Admin Configuration Panel â€“ Epic Added to Roadmap**
  - **Foundation ticket:** MODEL-001 (Scoring Model Registry)
  - **Dimension tickets:** DIM-010 (Dimension Manager), DIM-015 (Category Mapping)
  - **Index tickets:** ADMIN-020 (Index Mapping), ADMIN-030 (Band Editor)
  - **Config tickets:** ADMIN-040 (White-label), ADMIN-050 (Interpretation Engine)
  - **Internal tools:** ADMIN-060 (Dev Tools)
  - Updated `docs/INDEX.md` with Active Epics section
  - **Status:** Roadmap (not yet started)
  - **Intent:** Provide admin tools for dynamic configuration of dimensions, scoring, bands, and analytics

- 2025-12-06: **[NAMING-001] Evalia Insight Dimensions (EID) Framework â€“ Full Implementation**
  - **Naming Source of Truth:** Created `docs/INSIGHT_DIMENSIONS_NAMING.md` with:
    - Canonical dimension names and internal ID mappings
    - Deprecated terminology table (what NOT to use)
    - Code and UI referencing guidelines
  - **Shared Code Mapping:** Added to `shared/analytics.ts`:
    - `INSIGHT_DIMENSIONS` constant with id/indexType/label/shortLabel for all 5 dimensions
    - `getInsightDimensionLabel()` helper for UI layer mapping
    - `getInsightDimension()` helper for metadata lookup
    - Types: `InsightDimensionId`, `InsightDimensionIndexType`
  - **Documentation Updates:**
    - `ANALYTICS_MEASUREMENT_MODEL_PEOPLE_DEV.md`: Section headers renamed to "Dimension"
    - `ANALYTICS_METRIC_SPEC_PEOPLE_DEV.md`: Added terminology notes and EID cross-references
    - `ANALYTICS_PHILOSOPHY_PEOPLE_DEV.md`: Section headers renamed to "Dimension"
    - `ANALYTICS_UI_DESIGN.md`: Updated integration points to use "Dimension" terminology
    - `EVALIA_INSIGHT_DIMENSIONS.md`: Updated to cross-reference naming doc
  - **UI Updates:**
    - `IndexDistributionChart.tsx`: Default title changed to "Insight Dimension Distribution"
    - `AnalyticsPage.tsx`: Placeholder descriptions updated to use "Insight Dimensions"
  - **The Five Dimensions:**
    - Leadership Effectiveness (`leadership-effectiveness`)
    - Team Wellbeing (`team-wellbeing`)
    - Burnout Risk (`burnout-risk`)
    - Psychological Safety (`psychological-safety`)
    - Engagement Energy (`engagement`)
  - **No Breaking Changes:** Metric IDs, API routes, and DB schemas unchanged
  - **Intent:** Establish consistent brand terminology for marketing, docs, and UI

- 2025-12-06: **Analytics Documentation Refactor**
  - **Split Measurement Model:** Refactored `ANALYTICS_MEASUREMENT_MODEL_PEOPLE_DEV.md` into three focused documents:
    - `ANALYTICS_PHILOSOPHY_PEOPLE_DEV.md`: High-level "why" document (1-2 pages) explaining Evalia's positioning, who it serves, and the 5 core indices at a conceptual level
    - `ANALYTICS_MEASUREMENT_MODEL_PEOPLE_DEV.md`: Formal measurement model definition (no JSON, no UI) covering computation rules, indices, domains, and manager/team segmentation
    - `ANALYTICS_METRIC_SPEC_PEOPLE_DEV.md`: Technical specification with JSON shapes, metric IDs, and API endpoint definitions
  - **Removed Duplication:** Consolidated version-awareness rules, banding patterns, and computation rules into shared sections
  - **Cross-Linking:** Added "Related Documents" sections to all three docs for better navigation
  - **Intent:** Clarified people-development analytics model and separated measurement, metric spec, and UI spec into distinct documents to improve maintainability and guide future analytics implementation (BUILD-020, ANAL-* tickets)
  - No application code changes; documentation refactor only

- 2025-12-06: **[SCORE-001] Score Config Versioning**
  - **Database Schema**: Added `score_config_versions` table to store immutable scoring config snapshots
    - Fields: `id`, `survey_id`, `version_number`, `config_snapshot` (JSONB), `created_at`
    - Auto-incrementing version number per survey
  - **Response Linking**: Added `score_config_version_id` to `survey_responses` table
  - **Storage Layer**: Added CRUD operations in `IStorage` interface and both `MemStorage`/`DbStorage` implementations
    - `createScoreConfigVersion()`: Creates new version, auto-increments version number
    - `getScoreConfigVersion()`: Fetch by ID
    - `getLatestScoreConfigVersion()`: Get most recent version for a survey
    - `getScoreConfigVersions()`: List all versions for a survey
  - **Publish Hook**: When survey status changes to "Active" with scoring enabled, auto-creates version snapshot
  - **Response Submission**: Now links each response to the latest score config version
  - **Migration**: `migrations/0002_add_score_config_versions.sql` with all schema changes
  - This enables historical score stability - editing scoring config won't retroactively change past scores

- 2025-12-06: **[LOGIC-001] Validation Wired into Save Flow**
  - **SurveyBuilderContext**: `saveSurvey()` now calls `validateSurveyBeforePublish()` before save
    - Returns `{ id, validation }` instead of just ID
    - If errors exist, save is blocked (unless `skipValidation: true`)
    - `validateSurvey()` function exposed for manual validation
  - **BuilderActionBar**: Save button now shows `ValidationIssuesModal` on validation failure
    - If errors: blocks save, shows "Fix Issues" button
    - If only warnings: allows "Save Anyway" option
  - **ValidationIssuesModal**: Updated to support `onSaveAnyway` callback and flexible prop names
  - **surveyValidator.ts**: Added convenience arrays (`errors`, `warnings`, `logic`, `scoring`) for easier access

- 2025-12-05: **Validation UX + Audit Logging**
  - **Phase 4: Better UX for validation issues**
    - `ValidationIssueBadge`: Shows error/warning counts with icons
    - `ValidationIssuesModal`: Publish failure modal with grouped issues and jump-to links
    - `useValidation` hook: Memoized validation with helpers for filtering by question/rule/category
    - Updated `BuilderModeToggle` to show issue badges per mode (Logic/Scoring)
    - Updated `LogicRuleCard` to show inline issue messages and severity indicators
  - **Phase 5: Audit logging for analytics**
    - `server/auditLog.ts`: Structured logging for scoring/logic events
    - Logs only IDs and numeric values (NO PII or free-text)
    - Feature-flagged via `AUDIT_LOG_ENABLED` env var
    - Wired into response submission to log scoring completions
    - Log format: `[AUDIT] {"type":"scoring_complete",...}`

- 2025-12-05: **Logic & Scoring Validation Layer**
  - Created comprehensive architecture audit (`docs/LOGIC_SCORING_ARCHITECTURE.md`)
  - **Logic Validator** (`client/src/utils/logicValidator.ts`):
    - Builds question graph from survey (nodes + logic edges)
    - Detects: missing targets, backwards jumps/cycles, unreachable questions, conflicting rules
    - Returns structured `LogicValidationResult[]` with severity levels
  - **Scoring Validator** (`client/src/utils/scoringValidator.ts`):
    - Validates band coverage (no gaps 0-100), detects overlaps
    - Checks category usage (no orphans), invalid category references
    - Warns on weight imbalance and missing option scores
  - **Combined Validator** (`client/src/utils/surveyValidator.ts`):
    - `validateSurveyBeforePublish()` runs both logic + scoring checks
    - Returns unified `SurveyValidationResult` with summary counts
    - Includes general checks: empty questions, duplicate IDs, question limits
  - **Test Suite** (`client/src/__tests__/validation/`):
    - Logic validator tests: linear survey, missing targets, cycles, conflicts
    - Scoring validator tests: band gaps, overlaps, category usage, weights
  - Ready to wire into save/publish flow (UI integration pending)

- 2025-12-05: **Builder V2 â€“ Typography & header polish**
  - Created consistent section headers across Build, Logic, and Scoring modes
  - Unified header style: 15px medium text for section titles, 13px gray context/counts
  - Removed verbose instructional subtitles ("Click a rule badge to edit") for cleaner look
  - Simplified left panel headers: "Library", "Rules", "Setup" instead of verbose titles
  - Reduced right panel header weight and badge styling for understated minimalism
  - Updated section cards (Welcome/Thank You) to use quieter borders and typography
  - Removed redundant "Questions (n/200)" header from Build canvas
  - Design goal: professional, minimal interface that doesn't look AI-generated

- 2025-12-05: **Builder V2 â€“ Logic Question Timeline**
  - Added `LogicQuestionTimeline` component (Alchemer-style question flow visualization).
  - Shows all questions in a vertical timeline with logic rule badges attached to each question.
  - Badges show rule type (SKIP/SHOW/HIDE/END) and target question ID.
  - Selecting a rule highlights the trigger question (purple) and target question (blue).
  - Incoming jump indicators show which questions are targets of skip logic.
  - End of Survey marker shows the logical flow endpoint.
  - Expanded `LogicRuleList` width to 320px (380px on lg) to accommodate rule cards.
  - Improved text wrapping in `LogicRuleCard` for long conditions/actions.
  - Replaced empty center canvas in Logic mode with the interactive timeline.
  - **Visual cues upgrade (v2)**:
    - Added SVG connector lines from trigger â†’ target questions with curved paths and arrowheads
    - Lines are dashed/dimmed by default, solid purple-to-blue gradient when rule is selected
    - Dual highlighting: trigger question gets purple border/glow, target gets blue
    - Added "Trigger" and "Target" badge pills on selected questions
    - Logic badges now have hover tooltips explaining the rule
    - Badges scale up on hover and selection for better feedback
    - Cleaned up markdown from question text display
    - Human-readable condition formatting (e.g., `is "Yes"` instead of `answer("q1") == "Yes"`)
    - Improved typography to match app's system font stack

- 2025-12-05: **Scoring UI restructure to match Logic UI**
  - Converted Scoring mode from tabbed layout to 3-panel layout matching Logic mode:
    - **Left Panel**: New `ScoringNavigator` component with Categories/Bands toggle
    - **Center Panel**: QuestionMappingTable (filtered by category) or BandsTable
    - **Right Panel**: QuestionScoringInspector, BandEditor, or CategoryScoringInspector
  - Removed top tab navigation (Question Mapping / Categories & Bands)
  - Added view mode toggle in left panel (Categories vs Bands view)
  - Selecting a category filters the question mapping table
  - Visual cohesion: same spacing, borders, typography, and empty states as Logic mode
  - Logic and Scoring are now "sibling modes" with identical layout structure

- 2025-12-05: **Logic template redesign (best practices)**
  - **Template 1 (Adaptive Engagement):** Fixed illogical skip rules
    - OLD: 3 rules with same condition ("I do not manage others") but different targets (q5, q6, q7) - doesn't work
    - NEW: 1 rule that skips from Q1 directly to Q8 (wellbeing), effectively hiding Q5-Q7 for non-managers
  - **Template 2 (Turnover Risk):** Clarified two-path branching structure
    - SATISFIED PATH: Q1â†’Q2â†’Q3â†’(skip)â†’Q7â†’Q8â†’Q9â†’Q10 (retention & growth questions)
    - DISSATISFIED PATH: Q1â†’Q2â†’Q3â†’Q4â†’Q5â†’Q6â†’END (culture diagnostic then early exit)
    - Changed Q6 from likert to textarea for qualitative feedback
    - Made Q6 required to ensure END rule triggers reliably
    - Added PATH labels to question descriptions for clarity
  - Reseeded templates to database with corrected logic

- 2025-12-05: **Bug fix: Template import now preserves logic rules**
  - Fixed a bug where templates loaded from the Templates page were not loading their `logicRules` into the builder.
  - **Issue 1**: The template import flow in `SurveyBuilderContext.tsx` was missing `logicRules: q.logicRules` when passing questions to `evaliaToBuilder`.
    - Fix: Added `logicRules: q.logicRules` to the template import flow (matching the AI import flow).
  - **Issue 2**: The `validateLogicRules` function expects conditions in format `answer("questionId") == "value"`, but templates had simplified `answer == "value"` format.
    - Fix: Updated template conditions to use the full `answer("q1_role_type") == "value"` format.
  - Templates with `has_logic` tag now correctly load their skip/show/end rules into the Logic Builder.

- 2025-12-05: **Logic-based adaptive survey templates**
  - Added two new logic-based survey templates demonstrating conditional branching:
    - `logic_engagement_manager_adaptive_v1`: Adaptive Engagement & Manager Experience Survey
      - Role-based branching: non-managers skip leadership capability questions (q5-q7)
      - 10 questions across 6 scoring categories (Demographics, Engagement Drivers, Psychological Safety, Leadership Capability, Wellbeing, Growth & Development)
      - Full scoring configuration with 4 engagement bands
    - `logic_turnover_risk_diagnostic_v1`: Turnover Risk & Experience Diagnostic
      - Satisfaction-based branching: dissatisfied employees see risk diagnostic questions (q4-q6) then exit early
      - Satisfied/neutral employees skip directly to retention and growth questions (q7-q10)
      - 10 questions with weighted scoring (key retention questions count 2x)
      - 4 turnover risk bands from "Low Risk" to "Critical Risk"
  - Templates tagged with `has_logic` and `adaptive` for discoverability
  - Added `logicRules` arrays to trigger questions with structured conditions/actions
  - Updated `seedTemplates.ts` to seed logic-based templates separately with full metadata (tags, is_featured, scoreConfig)

- 2025-12-05: **Scoring system hardening**
  - Verified backend scoring payloads: `scoreConfig` (categories, bands, resultsScreen) is consistent from DB â†’ API â†’ builder.
  - Implemented `[SCORING-PIPELINE]` tagging and logging across storage, routes, builder context, builder UI, and scoring view to detect when scoring is enabled but categories/bands are empty.
  - Rebuilt the Docker image and cleared caches; Builder Scoring tab now correctly shows non-zero category and band counts for all scored surveys.

- 2025-12-05: **Builder V2 â€“ Logic/Scoring integration hardening**
  - Finalized wiring of Scoring mode in `SurveyBuilderV2` to the builder context using the `INTEGRATION_GUIDE` bridge types (`QuestionScoringConfig`, `ScoringCategory`, `CoreScoreBand`, `BuilderScoreBand`).
  - Added scoring state (`scoringByQuestionId`, `scoringCategories`, `scoringBands`) and updater functions (`setQuestionScoring`, `updateScoringCategory`, `updateScoringBand`, `deleteScoringBand`) to `SurveyBuilderContext`.
  - Cleaned up `QuestionScoringSection` so it uses builder scoring config consistently and remains UI-only without altering core scoring schemas.
  - Standardized severity usage in `CommandCenterWidgets` to the existing `"low" | "medium" | "high"` union, removing a stray `"critical"` severity that was causing TS errors.
  - Resolved legacy scoring configuration errors in `ScoringConfigStep` by marking it as legacy with `@ts-nocheck` (used only by the old builder).
  - Re-verified invariants: no changes to scoring engines or `SurveyView` runtime behavior, no introduction of forbidden runtime fields (`totalScore`, `percentage`, `scoringEngineId`) into the builder layer, and `INTEGRATION_GUIDE` remains builder-only.

- 2025-12-05: **Builder V2 â€“ Layout & scroll fixes**
  - Fixed vertical scrolling in the Builder V2 screen by restructuring the main layout.
  - Made the center panel (`Build / Logic / Scoring` modes) the primary scroll container via `overflow-y-auto` and `min-h-0`.
  - Updated `ScoringView` and `LogicView` to use simple `flex flex-col` layouts without redundant overflow constraints.

- 2025-12-05: **Builder V2 â€“ Full Scoring & Logic UI integration**
  - Created new scoring components: `QuestionMappingRow`, `QuestionMappingBulkBar`, `CategoryScoringInspector`, `BandRecommendationItem`.
  - Created logic components: `LogicRuleCard` for structured rule display with condition/action visualization.
  - Updated `QuestionMappingTable` to use row-based selection with bulk operations support.
  - Updated `BandEditor` to display recommendations when present.
  - Wired `ScoringView` with full editing callbacks (`onChangeQuestionScoring`, `onChangeCategory`, `onChangeBand`, `onDeleteBand`).
  - Wired `LogicView` to use `LogicRuleCard` for consistent rule display.
  - Connected `SurveyBuilderV2` to context functions (`setQuestionScoring`, `updateScoringCategory`, `updateScoringBand`, `deleteScoringBand`).
  - Added dev-only guard to scoring pipeline logging via `import.meta.env.DEV` checks.

- 2025-12-05: **Builder V2 â€“ Re-anchor to Magic Patterns golden spec**
  - Replaced all scoring and logic UI components with the original Magic Patterns (MP) design spec to reset UI fidelity.
  - **Scoring components re-anchored**: `BandRecommendationItem`, `QuestionMappingBulkBar`, `QuestionMappingRow`, `QuestionMappingTable`, `BandEditor`, `BandsTable`, `QuestionScoringInspector`, `CategoryScoringInspector`, `CategoriesList`, `ScoringView`.
  - **Logic components re-anchored**: `LogicView`, `LogicRuleList`, `LogicRuleCard`, `LogicRuleEditorPanel`.
  - **Shared components re-anchored**: `RightPanelLayout`, `QuestionHeader`, `QuestionScoringSection`.
  - Each component now has a `@design-locked` header comment indicating it follows the MP golden TSX.
  - Adapted imports to use `INTEGRATION_GUIDE` types while preserving exact MP markup and Tailwind classes.
  - Added `BuilderLogicRule` extended type to bridge MP's `questionId`/`conditionLabel`/`actionLabel` fields with our core schema.
  - Marked `ScoringSummaryPanel` as `@non-mp-design` (supplemental debug component, not from MP).
  - Severity model aligned: `BuilderScoreBand['severity']` uses `"low" | "medium" | "high" | "critical"` consistently.
  - **DESIGN LOCK POLICY**: Builder-extensions components are now design-locked. Props/types/wiring may change, but structure/CSS changes require explicit comparison to MP golden TSX.
  - Updated `INTEGRATION_GUIDE.ts` with design-lock policy documentation.

- 2025-12-15: **Dev tooling + runtime fixes**
  - Added dev-only Inspector (`/dev/inspector`) showing scoring/logic registries, AI endpoints, and template stats.
  - Added SurveyDebugPanel to Builder V2 for quick logic/scoring/results inspection (dev-only).
  - Standardized logic engine IDs (`logicEngineV3`) and added build-log reminder script (`npm run check:buildlog`).
  - Hardened design preview image handling and added theme regression tests; runtime results test unskipped with stubbed ResultsScreen.
  - Documented three creation entry points (AI draft with doc upload, template, scratch) all flowing into Builder V2 â†’ Design/Preview â†’ Publish/Share.
- 2025-12-16: **Process flow docs + runtime alignment**
  - Added Mermaid flow docs under `docs/flows/` for creation/publishing, lifecycle/runtime, scoring/results, AI, and theme/design.
  - Updated `ARCHITECTURE-SCORING-RESULTS.md` to reflect runtime theme normalization and the ResultsScreen vs Thank You branching rule.
  - Captured runtime/theme regression tests around SurveyView (results branching + theme normalization).
- 2025-12-17: **Architecture documentation suite**
  - Added `docs/architecture/` as the canonical architecture reference (overview, system architecture, data model/ERD + JSONB shapes, API map, and process flow index).
  - Indexed the new docs in `docs/INDEX.md` to keep them discoverable.
  - Noted future expansion for error/resilience and auth/session flows to keep diagrams aligned if/when added.
  - Added `QUESTION_SCHEMA_META` snapshot/diff guardrail with `schema:snapshot`/`schema:check` to prevent silent question parameter drift.

- 2025-12-09: **Evalia Build Log â€“ Major Update Summary**
  - Core architecture: unified rendering pipeline (Builder â†’ Runtime â†’ QuestionRenderer) plus refactored adapters with validation/normalization.
  - Logic V2: logicRules schema, structured QuestionLogicEditor UI, deterministic evaluator, and AI suggestion hooks scaffolded.
  - Scoring V1: pure scoring engine (weights, optionScores, categories, synthetic max previews) and new ScoringPanel wiring.
  - Results: ResultsScreen + ResultsConfigPanel with bands/narratives/category configs and Preview flow switching to Results â†’ Thank You.
  - Builder robustness: undo/redo stack, validation/normalization guards, integrity checks, safe defaults, audit logging flag, infinite-loop protection.
  - Testing: scoring, adapter round-trip, and results integration coverage.
  - Templates: flagship 31-item Canada Engagement Survey and Pulse variant seeded.
  - Backend prep: designed scoring controller/response schema/band resolver for server integration.

- 2025-12-08: **Evalia â€“ Recent Updates (Build Log Summary)**
  - Scoring engine: versioned `engagement_v1` with category weights, optionScores, bands, and deterministic pipeline; scores/bands stored on submit.
  - Results framework: layouts (simple/bands/dashboard), category breakdowns, band narratives, CTA config, and runtime branch to ResultsScreen.
  - Builder scoring panel: enables scoring, category mappings, weights, and band configuration in the V2 flow.
  - Template library: 31 templates normalized with canonical categories/tag taxonomy; leadership assessment template validated with scoring narratives.
  - Data + ops: DB seeds/migrations verified (JSON parsing fixes) and Docker environment stabilized for database access/app rebuilds.

- 2025-12-06: Captured the logic/scoring engine architecture (default `logicEngineV2`, optional `LogicV3`, and active `engagement_v1` scorer) and documented the AI endpoint surface plus template tag stats via the dev inspector so the current engines and catalog signals stay discoverable.
- 2025-12-07: Snapshot of the recent architecture hardening: AI guardrails/restoration (`aiService` with canonical tags + schema enforcement), LogicV3 added alongside default V2, scoring registry frozen (`engagement_v1`), deterministic resultsScreen/scoring flow, builder wiring for scoring/logic/results, design preview hardening, canonical template tags, expanded tests, and outstanding cleanup tasks captured in `ARCHITECTURE_SNAPSHOT.md`.
- 2025-12-05: Added a development-only `/dev/inspector` with snapshots of scoring engines, logic engines, AI endpoints, and template catalog stats; introduced scoring/logic registry modules for reuse.
- 2025-12-04: Added architecture index, builder-v2/core READMEs, and a dev-only Survey Debug panel that exposes survey state, scoring config, thank-you/results settings, and logic for quick inspection.
- 2025-12-03: Captured a comprehensive CHANGELOG plus a SurveyBuilderV2 snapshot of current flows and contracts to stabilize the 3-panel builder baseline.
- 2025-12-02: Hardened builder/preview flows: ensured design settings persist across pages, moved context sync outside setState to avoid runtime errors, set rating defaults, improved slider and NPS labels, and standardized preview sizing with auto-save.
- 2025-11-28: Logged completion of the AI integration program (expert personas, chain-of-thought refinement, JSON schema enforcement, and model routing for generation/refinement/analysis endpoints) to anchor the current AI architecture baseline.
- 2025-11-25: Initial marketing/insights experience refresh with optimized images, card slider for platform features, and analytics mockups showcased across the landing surfaces.
